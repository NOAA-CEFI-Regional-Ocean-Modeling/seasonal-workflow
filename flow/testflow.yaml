# conda activate uwtools
# uw rocoto realize --config-file testflow.yaml --output-file testflow.xml
# ~/git/rocoto/bin/rocotorun -d testflow.db -w testflow.xml
# ~/git/rocoto/bin/rocotostat -d testflow.db -w testflow.xml
workflow:
  attrs:
    realtime: false
    scheduler: slurm
  cycledef:
    - attrs:
        group: default
      # spec: "202412010000 202412010000 06:00:00"
      spec: "202209300000 202209300000 06:00:00"
  log: /home/acr/git/seasonal-workflow/flow/log.log
  entities:
    ANALYSIS_INPUT: /work/acr/mom6/nwa12/analysis_input_data
    FORECAST_INPUT: /work/acr/mom6/nwa12/forecast_input_data
    GAEA_INPUT: gaea:/gpfs/f6/ira-cefi/scratch/Andrew.C.Ross/northwest_atlantic/nwa12_input
    CONFIG: /home/acr/git/seasonal-workflow/config_nwa12_cobalt.yaml
  tasks:
    task_write_spear_atmos:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source flow/env_setup.sh; python write_spear_atmos.py -c &CONFIG; -y 2025 -m 1"
      jobname: write_spear_atmos
      partition: batch
      nodes: 1:ppn=1
      walltime: 02:00:00
      native: -D /home/acr/git/seasonal-workflow --output=flow/logs/spear_atmos_%j.out
    task_spear_gaea:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source env_setup.sh; gcp -cd -r -v &FORECAST_INPUT;/atmos/2025-01-e?? &GAEA_INPUT;/forecast_input_data/atmos"
      jobname: spear_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/spear_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_spear_atmos
    task_write_boundary_reanalysis:
      attrs:
        cycledefs: default
        maxtries: 5
      command: "source ../../flow/env_setup.sh; python write_boundary_reanalysis.py -c &CONFIG; -y 2024 -m 12"
      jobname: write_boundary_reanalysis
      partition: analysis
      nodes: 1:ppn=4
      walltime: 04:00:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/boundary --output=../../flow/logs/write_boundary_reanalysis_%j.out
    task_concat_boundary_reanalysis:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source ../../flow/env_setup.sh; python concat_boundary_reanalysis.py -c &CONFIG; -y 2024"
      jobname: concat_boundary_reanalysis
      partition: batch
      nodes: 1:ppn=1
      walltime: 00:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/boundary --output=../../flow/logs/concat_boundary_reanalysis_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_boundary_reanalysis
    task_boundary_gaea:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source env_setup.sh; gcp -cd -v &ANALYSIS_INPUT;/boundary/*_???_2024.nc &GAEA_INPUT;/analysis_input_data/boundary/"
      jobname: boundary_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/boundary_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: concat_boundary_reanalysis
    task_write_nudging_data:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source ../../flow/env_setup.sh; python write_nudging_data.py -c &CONFIG; -y 2024"
      jobname: write_nudging_data
      partition: batch
      nodes: 1:ppn=1
      walltime: 00:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/sponge --output=../../flow/logs/nudging_data_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_boundary_reanalysis
    task_nudging_gaea:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source env_setup.sh; gcp -cd -v &ANALYSIS_INPUT;/sponge/glorys_sponge_monthly_bnd_2024.nc &GAEA_INPUT;/analysis_input_data/sponge/"
      jobname: nudging_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: --output=logs/nudging_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_nudging_data
    task_write_runoff_glofas:
      attrs:
        cycledefs: default
        maxtries: 10
      command: "source ../../flow/env_setup.sh; python write_runoff_glofas.py -c &CONFIG; -y 2024"
      jobname: write_runoff_glofas
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/rivers --output=../../flow/logs/runoff_glofas_%j.out
    task_runoff_gaea:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source env_setup.sh; gcp -cd -v &ANALYSIS_INPUT;/rivers/glofasv4_runoff_2024.nc &GAEA_INPUT;/analysis_input_data/rivers/"
      jobname: runoff_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/runoff_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_runoff_glofas
    task_spear_gaea:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source env_setup.sh; gcp -cd -r -v &FORECAST_INPUT;/atmos/2025-01-e?? &GAEA_INPUT;/forecast_input_data/atmos"
      jobname: spear_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/spear_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_spear_atmos
    task_pad_era5:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source ../../flow/env_setup.sh; python pad_era5.py -c &CONFIG; -y 2024"
      jobname: pad_era5
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/atmos --output=../../flow/logs/pad_era5_%j.out
    task_era5_lp:
      attrs:
        cycledefs: default
        maxtries: 10
      command: "source ../../flow/env_setup.sh; python era5_lp.py -t &ANALYSIS_INPUT;/atmos/ERA5_tp_2024_padded.nc -s &ANALYSIS_INPUT;/atmos/ERA5_sf_2024_padded.nc -o &ANALYSIS_INPUT;/atmos/"
      jobname: era5_lp
      partition: batch
      nodes: 1:ppn=1
      walltime: 00:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/atmos --output=../../flow/logs/era5_lp_%j.out
      dependency:
        taskdep:
          attrs:
            task: pad_era5
    task_era5_sphum:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source ../../flow/env_setup.sh; python era5_sphum.py -d &ANALYSIS_INPUT;/atmos/ERA5_d2m_2024_padded.nc -p &ANALYSIS_INPUT;/atmos/ERA5_sp_2024_padded.nc"
      jobname: era5_sphum
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/atmos --output=../../flow/logs/era5_sphum_%j.out
      dependency:
        taskdep:
          attrs:
            task: pad_era5
    task_era5_gaea:
      attrs:
        cycledefs: default
        maxtries: 10
      command: "source ~/git/seasonal-workflow/flow/env_setup.sh; gcp -cd -v ERA5_strd_2024_padded.nc ERA5_ssrd_2024_padded.nc ERA5_lp_2024_padded.nc ERA5_sf_2024_padded.nc ERA5_msl_2024_padded.nc ERA5_t2m_2024_padded.nc ERA5_sphum_2024_padded.nc ERA5_u10_2024_padded.nc ERA5_v10_2024_padded.nc &GAEA_INPUT;/analysis_input_data/atmos/"
      jobname: era5_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 2:00:00
      native: -D &ANALYSIS_INPUT;/atmos/ --output=/home/acr/git/seasonal-workflow/flow/logs/era5_gaea_%j.out
      dependency:
        and:
          taskdep:
            attrs:
              task: pad_era5
          taskdep:
            attrs:
              task: era5_sphum
          taskdep:
            attrs:
              task: era5_lp
    # After analysis simulation has run:
    task_write_ics:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source flow/env_setup.sh; python write_ics_from_snapshot.py -c &CONFIG; -y 2025 -m 1 --new --rerun"
      jobname: write_ics
      partition: batch
      nodes: 1:ppn=1
      walltime: 02:00:00
      native: -D /home/acr/git/seasonal-workflow --output=flow/logs/ics_%j.out
      dependency:
        datadep:
          value: "/archive/acr/fre/NWA/2024_09/NWA12_COBALT_2024_09_now_nudgets-90d/gfdl.ncrc6-intel23-prod/3/history/20240101.nc.tar"
    task_ics_gaea:
      attrs:
        cycledefs: default
        maxtries: 3
      command: "source env_setup.sh; gcp -cd -v &FORECAST_INPUT;/initial/forecast_ics_2025-01.tar &GAEA_INPUT;/forecast_input_data/initial/"
      jobname: ics_gaea
      partition: batch
      nodes: 1:ppn=1
      walltime: 03:00:00
      native: --output=logs/ics_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_ics
    # Test how to use the cyclestr
    task_test_cyclestr:
      attrs:
        cycledefs: default
        maxtries: 3
      command: 
        # TODO: use an offset so that SPEAR is current month and year but 
        # everything else is minus one day?
        cyclestr:
          value:
            "echo @Y"
      jobname: test_cyclestr
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: -D /home/acr/git/seasonal-workflow --output=flow/logs/test_%j.out
