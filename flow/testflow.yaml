# conda activate uwtools
# uw rocoto realize --config-file testflow.yaml --output-file testflow.xml
# ~/git/rocoto/bin/rocotorun -d testflow.db -w testflow.xml
# ~/git/rocoto/bin/rocotostat -d testflow.db -w testflow.xml
# or ~/git/rocoto/bin/rocotoboot -d testflow.db -w testflow.xml -c all -t test_cyclestr_2
workflow:
  attrs:
    realtime: false
    scheduler: slurm
  cycledef:
    - attrs:
        group: default
      # spec: "202412010000 202412010000 06:00:00"
      #spec: "202501010000 202501010000 06:00:00"
      spec: "202410010000 202410010000 06:00:00"
  log: /home/acr/git/seasonal-workflow/flow/log.log
  entities:
    ANALYSIS_INPUT: /work/acr/mom6/nwa12/analysis_input_data
    FORECAST_INPUT: /work/acr/mom6/nwa12/forecast_input_data
    GAEA_INPUT: gaea:/gpfs/f6/ira-cefi/scratch/Andrew.C.Ross/northwest_atlantic/nwa12_input
    CONFIG: /home/acr/git/seasonal-workflow/config_nwa12_cobalt.yaml
    ENV_SETUP: "source ~/git/seasonal-workflow/flow/env_setup.sh;"
  tasks:
    task_write_spear_atmos:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          value: "&ENV_SETUP; python write_spear_atmos.py -c &CONFIG; -y @Y -m @m"
      partition: batch
      nodes: 1:ppn=1
      walltime: 02:00:00
      native: -D /home/acr/git/seasonal-workflow --output=flow/logs/spear_atmos_%j.out
    task_spear_gaea:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          value: "&ENV_SETUP; gcp -cd -r -v &FORECAST_INPUT;/atmos/@Y-@m-e?? &GAEA_INPUT;/forecast_input_data/atmos"
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/spear_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_spear_atmos
    task_write_boundary:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python write_boundary_reanalysis.py -c &CONFIG; -y @Y"
      partition: analysis
      nodes: 1:ppn=4
      walltime: 04:00:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/boundary --output=../../flow/logs/write_boundary_%j.out
    task_concat_boundary:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python concat_boundary_reanalysis.py -c &CONFIG; -y @Y"
      partition: batch
      nodes: 1:ppn=1
      walltime: 00:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/boundary --output=../../flow/logs/concat_boundary_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_boundary
    task_boundary_gaea:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; gcp -cd -v &ANALYSIS_INPUT;/boundary/*_???_@Y.nc &GAEA_INPUT;/analysis_input_data/boundary/"
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/boundary_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: concat_boundary
    task_write_nudging_data:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python write_nudging_data.py -c &CONFIG; -y @Y"
      partition: batch
      nodes: 1:ppn=1
      walltime: 00:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/sponge --output=../../flow/logs/nudging_data_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_boundary_reanalysis
    task_nudging_gaea:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; gcp -cd -v &ANALYSIS_INPUT;/sponge/glorys_sponge_monthly_bnd_@Y.nc &GAEA_INPUT;/analysis_input_data/sponge/"
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: --output=logs/nudging_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_nudging_data
    task_write_runoff_glofas:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python write_runoff_glofas.py -c &CONFIG; -y @Y"
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/rivers --output=../../flow/logs/runoff_glofas_%j.out
    task_runoff_gaea:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; gcp -cd -v &ANALYSIS_INPUT;/rivers/glofasv4_runoff_@Y.nc &GAEA_INPUT;/analysis_input_data/rivers/"
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: --output=logs/runoff_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_runoff_glofas
    task_pad_era5:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python pad_era5.py -c &CONFIG; -y @Y"
      partition: batch
      nodes: 1:ppn=1
      walltime: 01:00:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/atmos --output=../../flow/logs/pad_era5_%j.out
    task_era5_lp:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python era5_lp.py -t &ANALYSIS_INPUT;/atmos/ERA5_tp_@Y_padded.nc -s &ANALYSIS_INPUT;/atmos/ERA5_sf_@Y_padded.nc -o &ANALYSIS_INPUT;/atmos/"
      partition: batch
      nodes: 1:ppn=1
      walltime: 00:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/atmos --output=../../flow/logs/era5_lp_%j.out
      dependency:
        taskdep:
          attrs:
            task: pad_era5
    task_era5_sphum:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; python era5_sphum.py -d &ANALYSIS_INPUT;/atmos/ERA5_d2m_@Y_padded.nc -p &ANALYSIS_INPUT;/atmos/ERA5_sp_@Y_padded.nc"
      partition: batch
      nodes: 1:ppn=1
      walltime: 0:30:00
      native: -D /home/acr/git/seasonal-workflow/analysis_setup/atmos --output=../../flow/logs/era5_sphum_%j.out
      dependency:
        taskdep:
          attrs:
            task: pad_era5
    task_era5_gaea:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          attrs:
            offset: "-01:00:00:00"
          value: "&ENV_SETUP; gcp -cd -v ERA5_strd_@Y_padded.nc ERA5_ssrd_@Y_padded.nc ERA5_lp_@Y_padded.nc ERA5_sf_@Y_padded.nc ERA5_msl_@Y_padded.nc ERA5_t2m_@Y_padded.nc ERA5_sphum_@Y_padded.nc ERA5_u10_@Y_padded.nc ERA5_v10_@Y_padded.nc &GAEA_INPUT;/analysis_input_data/atmos/"
      partition: batch
      nodes: 1:ppn=1
      walltime: 2:00:00
      native: -D &ANALYSIS_INPUT;/atmos/ --output=/home/acr/git/seasonal-workflow/flow/logs/era5_gaea_%j.out
      # the and in these dependencies may not be interpreted correctly?
      dependency:
        and:
          taskdep:
            attrs:
              task: pad_era5
          taskdep:
            attrs:
              task: era5_sphum
          taskdep:
            attrs:
              task: era5_lp
    # After analysis simulation has run:
    task_write_ics:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          value: "&ENV_SETUP; python write_ics_from_snapshot.py -c &CONFIG; -y @Y -m @m --new --rerun"
      partition: batch
      nodes: 1:ppn=1
      walltime: 02:00:00
      native: -D /home/acr/git/seasonal-workflow --output=flow/logs/ics_%j.out
      dependency:
        datadep:
          value:
            cyclestr:
              value: "/archive/acr/fre/NWA/2024_09/NWA12_COBALT_2024_09_now_nudgets-90d/gfdl.ncrc6-intel23-prod/3/history/@Y@m01.nc.tar"
    task_ics_gaea:
      attrs:
        cycledefs: default
      command: 
        cyclestr:
          value: "&ENV_SETUP; gcp -cd -v &FORECAST_INPUT;/initial/forecast_ics_@Y-@m.tar &GAEA_INPUT;/forecast_input_data/initial/"
      partition: batch
      nodes: 1:ppn=1
      walltime: 03:00:00
      native: --output=logs/ics_gaea_%j.out
      dependency:
        taskdep:
          attrs:
            task: write_ics
