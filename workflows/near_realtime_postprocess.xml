<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE workflow [
  <!ENTITY CONFIG "/home/acr/git/seasonal-workflow/config_nwa12_cobalt.yaml">
  <!ENTITY ENV_SETUP "source /home/acr/git/seasonal-workflow/workflows/env_setup.sh;">
  <!ENTITY QC_SETUP "source /home/acr/git/ncqc/.venv/bin/activate;">
  <!ENTITY LOGS "/home/acr/git/seasonal-workflow/workflows/logs">
  <!ENTITY FORECAST_OUTPUT "/work/acr/mom6/nwa12/forecast_output_data/individual">
  <!ENTITY COLLAB "/collab1/data_untrusted/Andrew.C.Ross/to_cefi_data_portal">
  <!ENTITY VARIABLES "tos tob sos sob MLD_003 btm_o2 btm_co3_sol_arag btm_co3_ion btm_htotal no3os phos po4os sios talkos dissicos pco2surf sfc_co3_ion sfc_co3_sol_arag
">
  <!ENTITY DOMAINS "ocean_month ocean_month ocean_month ocean_month ocean_month ocean_cobalt_btm ocean_cobalt_btm ocean_cobalt_btm ocean_cobalt_btm ocean_cobalt_omip_sfc ocean_cobalt_omip_sfc ocean_cobalt_omip_sfc ocean_cobalt_omip_sfc ocean_cobalt_omip_sfc ocean_cobalt_omip_sfc ocean_cobalt_sfc ocean_cobalt_sfc ocean_cobalt_sfc
">
]>
<workflow realtime="True" scheduler="slurm" cyclethrottle="3">
  <cycledef group="default">0 0 1 */3 2025 *</cycledef>
  <log>
    <cyclestr>/home/acr/git/seasonal-workflow/workflows/nrt_postprocess_@Y-@m.log</cyclestr>
  </log>
  <metatask name="postprocess_extract" mode="parallel" throttle="3">
    <var name="domain">ocean_month ocean_cobalt_btm ocean_cobalt_omip_sfc ocean_cobalt_sfc</var>
    <task name="pp_extract_#domain#" cycledefs="default" maxtries="2">
      <nodes>1:ppn=1</nodes>
      <partition>analysis</partition>
      <walltime>3600</walltime>
      <command>
        <cyclestr>&ENV_SETUP; python forecast_postprocess/postprocess_extract_fields.py -c config_nwa12_cobalt.yaml -d #domain# -y @Y -m @m --new</cyclestr>
      </command>
      <jobname>pp_extract_#domain#</jobname>
      <native>-D /home/acr/git/seasonal-workflow --nodelist=an211 --output=&LOGS;/pp_extract_%j.out</native>
    </task>
  </metatask>
  <metatask name="postprocess_combine" mode="parallel" throttle="3">
    <var name="variable">&VARIABLES;</var>
    <var name="domain">&DOMAINS;</var>
    <task name="pp_combine_#domain#_#variable#" cycledefs="default" maxtries="4">
      <nodes>1:ppn=1</nodes>
      <partition>analysis</partition>
      <walltime>0:30:00</walltime>
      <command>
        <cyclestr>&ENV_SETUP; python forecast_postprocess/postprocess_combine_new_forecasts.py -c config_nwa12_cobalt.yaml -d #domain# -v #variable# -y @Y -m @m</cyclestr>
      </command>
      <jobname>pp_combine_#domain#_#variable#</jobname>
      <native>-D /home/acr/git/seasonal-workflow --exclude=an[001-002,007-012,014] --output=&LOGS;/pp_combine_%j.out</native>
      <dependency>
        <taskdep task="pp_extract_#domain#"/>
      </dependency>
    </task>
  </metatask>
  <metatask name="postprocess_qc" mode="parallel" throttle="3">
    <var name="variable">&VARIABLES;</var>
    <var name="domain">&DOMAINS;</var>
    <task name="pp_qc_#domain#_#variable#" cycledefs="default" maxtries="4">
      <nodes>1:ppn=1</nodes>
      <partition>batch</partition>
      <walltime>0:30:00</walltime>
      <command>
        <cyclestr>&QC_SETUP; /nbhome/acr/local/bin/uv run /home/acr/git/ncqc/ncqc.py &FORECAST_OUTPUT;/#variable#.nwa.full.ss_fcast.monthly.raw.r20250710.enss.i@Y@m.nc -c workflows/qc_ocean.yaml workflows/qc_monthly.yaml --fail-on-error</cyclestr>
      </command>
      <jobname>pp_qc_#domain#_#variable#</jobname>
      <native>-D /home/acr/git/seasonal-workflow --output=&LOGS;/pp_qc_%j.out</native>
      <dependency>
        <taskdep task="pp_combine_#domain#_#variable#"/>
      </dependency>
    </task>
  </metatask>
  <metatask name="postprocess_stage" mode="parallel" throttle="3">
    <var name="variable">&VARIABLES;</var>
    <var name="domain">&DOMAINS;</var>
    <task name="pp_stage_#domain#_#variable#" cycledefs="default" maxtries="2">
      <nodes>1:ppn=1</nodes>
      <partition>analysis</partition>
      <walltime>0:05:00</walltime>
      <command>
        <cyclestr>&ENV_SETUP; gcp -cd -v &FORECAST_OUTPUT;/#variable#.nwa.full.ss_fcast.monthly.raw.r20250710.enss.i@Y@m.nc &COLLAB;/</cyclestr>
      </command>
      <jobname>pp_stage_#domain#_#variable#</jobname>
      <native>-D /home/acr/git/seasonal-workflow --output=&LOGS;/pp_stage_%j.out</native>
      <dependency>
        <taskdep task="pp_qc_#domain#_#variable#"/>
      </dependency>
    </task>
  </metatask>
</workflow>
